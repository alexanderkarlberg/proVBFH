######################################################################
# Makefile for proVBFH-inclusive 
#
#  - "make" creates the vbfh executable
#  - "make clean" removes all files created by the "make" command
######################################################################

# include the settings from Makefile.inc, generated by configure script
include Makefile.inc

# Get the version
HOPPET_VERSION := $(shell hoppet-config --version 2>/dev/null || echo "not-found")

# Check if hoppet-config exists
ifeq ($(HOPPET_VERSION),not-found)
$(error hoppet-config not found. Please install hoppet or add it to PATH)
endif

# Extract major version (first number before the dot)
HOPPET_MAJOR := $(shell echo $(HOPPET_VERSION) | cut -d. -f1)

# Check if major version is at least 2
HOPPET_MAJOR_OK := $(shell [ $(HOPPET_MAJOR) -ge 2 ] && echo yes || echo no)

ifeq ($(HOPPET_MAJOR_OK),no)
$(error hoppet version $(HOPPET_VERSION) is too old. Required: 2.0.0 or newer. Please clone the newest version of hoppet from the git repository)
endif

$(info Found hoppet version: $(HOPPET_VERSION))

# main program and modules to be compiled
MAIN = provbfh_incl provbfhh_incl
MODULES = integration phase_space parameters io_utils lcl_dec matrix_element \
          matrix_element_dihiggs phase_space_dihiggs tensor ME_expressions

# librairies and flags needed for compilation
#FF = ifort
SRC=$(PWD)/src
OBJ=$(PWD)/obj
VPATH=./:$(SRC):/$(OBJ)

FFLAGS= -O3 -ffixed-line-length-132 
FFLAGS+= $(shell $(HPEXEC) --fflags)
INCLUDE= -I$(SRC) $(wildcard *.h)
FFLAGS+= $(INCLUDE) -J$(OBJ)
LDFLAGS= $(shell $(HPEXEC) --libs) $(shell $(LHEXEC) --libs)

all: provbfh_incl

# main program
$(MAIN): %: %.o $(addsuffix .o,$(MODULES)) Makefile
	$(FF) $(OBJ)/$@.o $(patsubst %,$(OBJ)/%,$(addsuffix .o,$(MODULES))) \
	$(FFLAGS) $(LDFLAGS) -o $@

# object files
%.o: %.f Makefile 
	$(FF) $(FFLAGS) -o $(OBJ)/$@ $< -c

%.o: %.f90 Makefile
	$(FF) $(FFLAGS) -o $(OBJ)/$@ $< -c

# f90 module dependencies
phase_space.o: matrix_element.o parameters.o
phase_space_dihiggs.o: matrix_element_dihiggs.o parameters.o
provbfh_incl.o: matrix_element.o parameters.o phase_space.o integration.o
provbfhh_incl.o: matrix_element_dihiggs.o parameters.o phase_space_dihiggs.o integration.o
parameters.o: io_utils.o lcl_dec.o integration.o
matrix_element.o: parameters.o
matrix_element_dihiggs.o: parameters.o tensor.o ME_expressions.o

# make clean
clean:
	rm -f $(OBJ)/*.o $(OBJ)/*.mod *~ *.log fort* $(MAIN)

